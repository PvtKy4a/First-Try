#define BIT_SET(PORTx, BIT) (PORTx |= BIT)
#define BIT_RESET(PORTx, BIT) (PORTx &= ~BIT)
#define BIT_CHECK(PINx, BIT) (PINx & BIT)
#define SP7 (1 << 5)
#define SP5 (1 << 6)
#define SP3 (1 << 7)
#define SP1 (1 << 0)
#define PRE_IN (1 << 1)
#define SP7_PORT PORTD
#define SP5_PORT PORTD
#define SP3_PORT PORTD
#define SP1_PORT PORTD
#define PRE_IN_PORT PORTD
#define PRE_IN_PORT_CHECK PIND
#define INITIAL_STATE 0
#define SECOND_STATE 1

uint8_t btn_isClick(void);
void IO_Init(void);

uint8_t sp_list[5] = {SP7, SP5, SP3, SP1, PRE_IN};
uint8_t sp_list_size = sizeof(sp_list) / sizeof(sp_list[0]) - 1;
uint8_t sp_port_list[5] = {SP7_PORT, SP5_PORT, SP3_PORT, SP1_PORT, PRE_IN_PORT};

void setup() {

  IO_Init();

}

void loop() {

  uint32_t timer_ms = millis();
  static uint32_t period_timer = 0;
  static uint8_t sp_number = 0;
  static uint16_t period = 1000;
  static bool switch_flag = false;
  static bool start_flag = false;
  if (btn_isClick())
  {
    start_flag = !start_flag;
    if (start_flag == false)
    {
      switch_flag = false;
      sp_number = INITIAL_STATE;
    }
    period_timer = timer_ms - period;
  }
  if (timer_ms - period_timer >= period && start_flag == true)
  {
    period_timer = timer_ms;
    uint8_t previous_sp_number = sp_number - 1;
    switch (switch_flag)
    {
      case (false):
        {
          if (BIT_CHECK(PRE_IN_PORT_CHECK, PRE_IN) == true && sp_number == INITIAL_STATE) BIT_RESET(PRE_IN_PORT, PRE_IN);
          BIT_SET(sp_port_list[sp_number], sp_list[sp_number]);
          if (sp_number < SECOND_STATE) ++sp_number;
          else switch_flag = true;
        }
        break;
      case (true):
        {
          BIT_RESET(sp_port_list[previous_sp_number], sp_list[previous_sp_number]);
          ++sp_number;
          if (sp_number > sp_list_size) sp_number = INITIAL_STATE;
          switch_flag = false;
        }
        break;
    }
  }

}

void IO_Init(void)
{
  DDRB &= ~1 << 4;
  PORTB |= 1 << 4;
  DDRD |= 0xE0;
  DDRB |= 0x3;
}

uint8_t btn_isClick(void)
{
  uint32_t timer_ms = millis();
  static uint32_t pressed_debounce_timer = 0;
  static uint32_t released_debounce_timer = 0;
  const uint8_t debounce_delay_ms = 50;
  static bool btn_pressed = false;
  bool _btn_isClick = false;
  if (!(PINB & 1 << 4) && btn_pressed == false && timer_ms - pressed_debounce_timer >= debounce_delay_ms)
  {
    pressed_debounce_timer = timer_ms;
    released_debounce_timer = timer_ms;
    btn_pressed = true;
    _btn_isClick = true;
  }
  if ((PINB & 1 << 4) && btn_pressed == true && timer_ms - released_debounce_timer >= debounce_delay_ms)
  {
    released_debounce_timer = timer_ms;
    pressed_debounce_timer = timer_ms;
    btn_pressed = false;
  }
  return _btn_isClick;
}
